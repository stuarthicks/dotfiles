#!/bin/bash
set -eu

# Terminal colours!
readonly BLUE=$(tput setaf 6)
readonly RESET=$(tput sgr0)

if [ "$(uname)" = 'Darwin' ]; then
  if softwareupdate -h > /dev/null 2>&1; then
    echo "${BLUE}Installing macOS system and App Store updates...${RESET}"
    softwareupdate --install --all --include-config-data
  fi

  if brew -h > /dev/null 2>&1; then
    echo
    echo "${BLUE}Updating Homebrew...${RESET}"
    brew update
    brew upgrade
    (
      cd ~/.dotfiles
      brew bundle
    )
  fi
fi

if [ "$(uname)" = 'Linux' ]; then
  if apt -h > /dev/null 2>&1; then
    echo "${BLUE}Updating apt....${RESET}"
    sudo apt update
    sudo apt full-upgrade --yes
    sudo apt autoremove --yes
  fi

  if snap -h > /dev/null 2>&1; then
    echo
    echo "${BLUE}Updating Snap...${RESET}"
    snap refresh
  fi

  if flatpak -h > /dev/null 2>&1; then
    echo
    echo "${BLUE}Updating Flatpak...${RESET}"
    flatpak update --assumeyes
  fi
fi

if asdf -h > /dev/null 2>&1; then
  echo
  echo "${BLUE}Updating asdf-vm...${RESET}"
  asdf update
  asdf plugin update --all
fi

if go env > /dev/null 2>&1; then
  echo
  echo "${BLUE}Updating Go tooling...${RESET}"
  go get -u -v github.com/gojp/goreportcard
  go get -u -v github.com/maruel/panicparse/cmd/pp
  go get -u -v github.com/rogpeppe/gohack
  go get -u -v github.com/smartystreets/goconvey
  go get -u -v golang.org/x/tools/gopls
fi

if nvim -h > /dev/null 2>&1; then
  echo
  echo "${BLUE}Updating Neovim plugins...${RESET}"
  nvim +'call dein#update()' +qall
fi

if [ "$(uname)" = 'Linux' ]; then
  echo
  echo "${BLUE}Checking if reboot is required...${RESET}"
  (stat /var/run/reboot-required > /dev/null 2>&1 && echo 'Reboot required') || echo 'No reboot required'
fi
