#!/bin/sh
set -eu

REPO=$1
DIR=${2:-}

test -z ${DIR:-} && DIR=$(basename "$REPO")

mkdir -p "$DIR"
cd "$DIR"

git clone --recursive --bare "$REPO" .bare
echo 'gitdir: ./.bare' > .git

# Prevents new worktrees uploading all git-lfs objects on first push
git config 'remote.origin.fetch' '+refs/heads/*:refs/remotes/origin/*'

git worktree add "$(git rev-parse --abbrev-ref HEAD)"
