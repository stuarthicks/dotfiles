#!/usr/bin/env bash
set -euo pipefail

if [[ "$*" =~ "--profile" ]]; then
  PROFILE=$(echo "$*" | rextract -e '--profile ([^ ]+)')
  eval "$(source awsume $PROFILE -s)"

  for arg do
    shift
    [ "$arg" = "--profile" ] && continue
    [ "$arg" = "$PROFILE" ] && continue
    set -- "$@" "$arg"
  done
fi

/opt/homebrew/bin/aws $@
